{% extends "base.html" %}
{% block body_class %}dashboard{% endblock %}

{% block page_content %}
    {# 1행 #}

    <div class="card" id="box-1-empty"> 
        <div class="card-header">미정</div>
        <div class="card-body"></div>
    </div>

    <div class="card box3" id="근무-현황">
        <div class="card-header">근무 현황 (총 {{ total_employees_count }}명)</div>
        <div class="card-body attendance-summary-circles" style="overflow-y: auto; height: 100%; padding: 10px; justify-content: space-evenly;">
            <div class="status-circle-item">
                <div class="circle green-bg">
                    <span class="count">{{ status_counts['재실'] }}</span>명
                </div>
                <div class="label">재실</div>
            </div>
            <div class="status-circle-item">
                <div class="circle blue-bg">
                    <span class="count">{{ status_counts['휴가'] }}</span>명
                </div>
                <div class="label">휴가</div>
            </div>
            <div class="status-circle-item">
                <div class="circle orange-bg">
                    <span class="count">{{ status_counts['외근/출장'] }}</span>명
                </div>
                <div class="label">외근/출장</div>
            </div>
            <div class="status-circle-item">
                <div class="circle red-bg">
                    <span class="count">{{ status_counts['부재'] }}</span>명
                </div>
                <div class="label">부재</div>
            </div>
        </div>
    </div>

    <div class="card" id="box-3-empty"> 
        <div class="card-header">미정</div>
        <div class="card-body"></div>
    </div>

    {# 2행 #}

    <div class="card box1" id="최신-공지">
        <div class="card-header employee-list-header">
            <span>최신 공지</span>
            {% if g.user.role == 'admin' %}
            <a href="{{ url_for('add_notice_page') }}" class="sub-action-btn header-btn">➕ 새 글 작성</a>
            {% endif %}
        </div>
        <div class="card-body notice-list" style="overflow-y: auto; height: 100%;">
            {% for notice in notices %}
            <div class="notice-item">
                <div class="notice-header">
                    <a href="{{ url_for('view_notice', notice_id=notice['id']) }}" class="notice-title-link">
                        <strong>{{ notice['title'] }}</strong>
                    </a>
                    {% if g.user.role == 'admin' %}
                    <form action="{{ url_for('delete_notice', notice_id=notice['id']) }}" method="POST" onsubmit="return confirm('이 공지를 삭제하시겠습니까?');" style="display: inline;">
                        <button type="submit" class="delete-notice-btn">X</button>
                    </form>
                    {% endif %}
                </div>
                <p class="notice-content-preview">{{ (notice['content']|striptags|truncate(80))|replace('\n', ' ') }}</p>
            </div>
            {% else %}
            <p>등록된 공지사항이 없습니다.</p>
            {% endfor %}
        </div>
    </div>

    <div class="card box2" id="부서별-인원-현황">
        <div class="card-header">부서별 인원 현황 (재직자 기준)</div>
        <div class="card-body" style="overflow-y: auto; height: 100%;">
            <canvas id="departmentChart"></canvas>
        </div>
    </div>

    <div class="card box4" id="급여-관리">
        <div class="card-header">급여 관리 (예시)</div>
        <div class="card-body">Content for 급여 관리.</div>
    </div>

    <script>
        // 템플릿 렌더링 시 app.py에서 넘겨준 데이터를 사용합니다.
        const deptLabels = {{ dept_labels|tojson }};
        const deptCounts = {{ dept_counts|tojson }};
        const ctx = document.getElementById('departmentChart');
        
        // 차트가 박스 크기에 맞도록 옵션 조정
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: deptLabels,
                datasets: [{
                    label: '부서별 인원',
                    data: deptCounts,
                    borderWidth: 1,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)'
                }]
            },
            options: {
                responsive: true, // ⬅️ 박스 크기에 맞게 반응
                maintainAspectRatio: false, // ⬅️ 비율 유지 끄기 (박스에 꽉 차게)
                scales: { 
                    y: { 
                        beginAtZero: true, 
                        ticks: { stepSize: 1 } 
                    } 
                },
                plugins: { legend: { display: false } }
            }
        });
    </script>
{% endblock %}