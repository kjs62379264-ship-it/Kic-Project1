{% extends "base_layout.html" %}
{# 이 파일은 사이드바, 플래시 메시지, 메인 콘텐츠 레이아웃을 담당합니다. #}

{% block title %}{% block page_title %}대시보드{% endblock %} - 인사관리 시스템{% endblock %}

{% block body_class %}{% block page_body_class %}{% endblock %}{% endblock %}

{% block content %}
<div class="main-container">
    
    {# g.user가 있을 때(로그인 상태)만 사이드바를 표시합니다. #}
    {% if g.user %}
<aside class="sidebar">
        
        <div class="profile-area">
            <div class="profile-photo" 
                 {# ✨ g.user를 딕셔너리로 접근하도록 수정 #}
                 style="background-image: url('{{ url_for('static', filename='profile_photos/' + (g.user['profile_image'] or 'default.jpg')) }}');"></div>
            <div class="user-info">
                {# ✨ g.user를 딕셔너리로 접근하도록 수정 #}
                <p class="user-name">{{ g.user['name'] }} ({{ g.user['position'] }})</p> 
                <p class="user-dept">{{ g.user['department'] }}</p> 
            </div>
            
            <div class="attendance-section">
                {# attendance_button_state에 따른 버튼 상태 결정 #}
                {% if attendance_button_state == '퇴근' %}
                    <form action="{{ url_for('clock') }}" method="POST">
                        <button type="submit" class="btn attendance-btn check-out">퇴근</button>
                    </form>
                {% elif attendance_button_state == '출근' %}
                    <form action="{{ url_for('clock') }}" method="POST">
                        <button type="submit" class="btn attendance-btn check-in">출근</button>
                    </form>
                {% elif attendance_button_state == '완료' %}
                    <button class="btn attendance-btn" style="background-color: #7f8c8d; cursor: default;" disabled>출퇴근 완료</button>
                {% else %}
                    {# '연차', '외근' 등 휴가/부재 상태일 때 #}
                    <button class="btn attendance-btn" style="background-color: #3498db; cursor: default;" disabled>{{ attendance_button_state }}</button>
                {% endif %}
                
                </div> </div> <nav>
            <ul>
                <li class="has-submenu">
                    <a href="{{ url_for('hr_management') }}">인사 관리</a>

                    {% if g.user.role == 'admin' %}
                    <ul class="submenu-info">
                        <li><a href="{{ url_for('add_employee') }}">- 신규 직원 등록</a></li>
                        <li><a href="{{ url_for('print_employees', **request.args) }}" target="_blank">- 명부 인쇄</a></li>
                        <li><a href="{{ url_for('add_notice_page') }}">- 공지사항 작성</a></li>
                        <li><a href="{{ url_for('settings_management') }}">- 부서/직급 관리</a></li>
                    </ul>
                    {% endif %}
                </li>
                <li><a href="{{ url_for('attendance') }}">근태 관리</a></li> 
                {# ✨ [수정] 급여 관리 링크 연결 #}
                <li><a href="{{ url_for('salary_management') }}">급여 관리</a></li> 
                
                <li style="border-top: 1px solid #eee; margin-top: 10px; padding-top: 10px;"></li>
                <li><a href="{{ url_for('change_password') }}">비밀번호 변경</a></li>
                <li><a href="{{ url_for('logout') }}" class="logout-link" style="color: #e74c3c;">로그아웃</a></li>
            </ul>
        </nav>
    </aside>
    {% endif %} {# (g.user 로그인 체크 끝) #}
    
<main class="content-grid">
    
    {% with messages = get_flashed_messages(with_categories=true) %}
    
    {% if messages %}
        <div style="grid-column: 1 / -1;">
            {% for category, message in messages %}
                <div class="alert {{ 'alert-danger' if category == 'error' else 'alert-success' }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {# "page_content" 블록에 실제 페이지 내용이 들어갑니다. #}
    {% block page_content %}
    {% endblock %}
    
    {% endwith %}
</main>
</div>

<script>
    // 이 함수는 폼이 제출될 때 호출됩니다.
    function handleSubmit(form) {
        const button = form.querySelector('.attendance-btn'); // 클래스로 버튼 찾기
        if (button.disabled) {
            return false; // 이미 비활성화 상태면 제출을 막습니다.
        }
        // 브라우저 저장소에 현재 클릭 시간을 기록합니다.
        localStorage.setItem('lastClockTime', Date.now());
        return true; // 폼 제출을 허용합니다.
    }

    // 이 함수는 페이지가 로드될 때마다 실행됩니다.
    window.addEventListener('load', () => {
        const forms = document.querySelectorAll('.attendance-section form');
        
        forms.forEach(form => {
            const button = form.querySelector('.attendance-btn');
            if (!button) return;

            form.onsubmit = function() { return handleSubmit(this); };

            const lastClockTime = localStorage.getItem('lastClockTime');
            const cooldownPeriod = 5000; // 5초 (5000ms)

            if (lastClockTime) {
                const timePassed = Date.now() - parseInt(lastClockTime);

                if (timePassed < cooldownPeriod) {
                    const remainingTime = cooldownPeriod - timePassed;
                    let countdown = Math.ceil(remainingTime / 1000);

                    button.disabled = true;
                    button.style.cursor = 'wait';
                    button.innerText = `대기... (${countdown}초)`;

                    const interval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            button.innerText = `대기... (${countdown}초)`;
                        }
                    }, 1000);

                    setTimeout(() => {
                        clearInterval(interval);
                        button.disabled = false;
                        button.style.cursor = 'pointer';
                        // 버튼 텍스트는 서버에서 새로 렌더링된 값이므로 그대로 둡니다.
                        if (button.classList.contains('check-in')) {
                            button.innerText = '출근';
                        } else if (button.classList.contains('check-out')) {
                            button.innerText = '퇴근';
                        }
                    }, remainingTime);
                }
            }
        });
    });
</script>

{% endblock %}