{% extends "base.html" %}

{% block page_title %}ê¸‰ì—¬ ê´€ë¦¬{% endblock %}

{% block page_content %}

<div class="card" style="grid-column: 1 / 3;">
    <div class="card-header employee-list-header">
        {# ê´€ë¦¬ì ëª¨ë“œ í—¤ë” #}
        {% if is_admin %}
            <div>ì§ì›ë³„ ê¸°ë³¸ ê¸‰ì—¬ ì •ë³´ ê´€ë¦¬</div>
            <div class="header-actions">
                {# ì›”ë³„ ê¸‰ì—¬ ê³„ì‚° í¼ #}
                <form method="POST" action="{{ url_for('record_monthly_payroll') }}" 
                      onsubmit="return confirm('{{ current_month }} ê¸‰ì—¬ë¥¼ í™•ì •í•˜ê³  ê¸°ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì¤‘ë³µ ê¸°ë¡ ë¶ˆê°€)');" 
                      style="display: flex; gap: 10px;">
                    <input type="month" id="pay_month" name="pay_month" required 
                           value="{{ current_month }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 1em;">
                    <button type="submit" class="main-action-btn header-btn">ğŸ’° ê¸‰ì—¬ ê³„ì‚°/ê¸°ë¡</button>
                </form>
            </div>

        {# ì¼ë°˜ ì§ì› ëª¨ë“œ í—¤ë” #}
        {% else %}
            <div>{{ g.user.name }} ë‹˜ ê¸‰ì—¬ ì •ë³´</div>
        {% endif %}
    </div>

    <div class="card-body">
        
        {% if is_admin %}
            {# ---------------------------------------------------------------- #}
            {# A. ê´€ë¦¬ì ë·°: ì „ì²´ ì§ì› ëª©ë¡ ë° ê¸°ë³¸ ê¸‰ì—¬ ì •ë³´ í‘œì‹œ #}
            {# ---------------------------------------------------------------- #}
            
            <h4 style="margin-bottom: 15px;">ì¬ì§ ì§ì› ê¸°ë³¸ ê¸‰ì—¬ ê¸°ì¤€</h4>
            <table class="employee-table">
                <thead>
                    <tr>
                        <th style="width: 80px;">ì‚¬ë²ˆ</th>
                        <th>ì´ë¦„</th>
                        <th>ë¶€ì„œ/ì§ê¸‰</th>
                        <th style="width: 150px; text-align: right;">ì—°ë´‰/ê¸°ë³¸ê¸‰</th>
                        <th style="width: 100px;">ê³„ì•½ í˜•íƒœ</th>
                        <th style="width: 150px; text-align: center;">ê¸°ë³¸ ì •ë³´ ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody>
                    {% for emp in employees %}
                    <tr>
                        <td>{{ emp['id'] }}</td>
                        <td>{{ emp['name'] }}</td>
                        <td>{{ emp['department'] }} / {{ emp['position'] }}</td>
                        <td style="text-align: right; font-weight: bold;">
                            {% if emp['base_salary'] %}
                                {{ "{:,}".format(emp['base_salary']) }}ì›
                            {% else %}
                                <span style="color: #e74c3c;">ë¯¸ë“±ë¡</span>
                            {% endif %}
                        </td>
                        <td>{{ emp['contract_type'] if emp['contract_type'] else '-' }}</td>
                        <td style="text-align: center;">
                            {# ê¸‰ì—¬ ì •ë³´ ë“±ë¡/ìˆ˜ì • ë²„íŠ¼ (edit_salary.htmlë¡œ ì—°ê²°) #}
                            <a href="{{ url_for('add_salary_info', employee_id=emp['id']) }}" class="detail-btn">
                                {{ 'ìˆ˜ì •' if emp['base_salary'] else 'ë“±ë¡' }}
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <hr style="margin-top: 30px; margin-bottom: 30px;">

            {# TODO: ì›”ë³„ ê¸‰ì—¬ ì§€ê¸‰ ê¸°ë¡ ëª©ë¡ì„ ì¡°íšŒí•˜ëŠ” ì„¹ì…˜ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„) #}
            <h4 style="color: #34495e;">ì›”ë³„ ê¸‰ì—¬ ì§€ê¸‰ ê¸°ë¡ ì„¹ì…˜ (í–¥í›„ êµ¬í˜„ ì˜ˆì •)</h4>
            <p>ì§ì›ë“¤ì˜ ì›”ë³„ ì§€ê¸‰ ê¸°ë¡ì„ ì¡°íšŒí•˜ê³  ê´€ë¦¬í•˜ëŠ” í…Œì´ë¸”ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>


        {% else %}
            {# ---------------------------------------------------------------- #}
            {# B. ì¼ë°˜ ì§ì› ë·°: ë³¸ì¸ ê¸‰ì—¬ ì •ë³´ ë° ê¸°ë¡ í‘œì‹œ #}
            {# ---------------------------------------------------------------- #}
            
            {% if salary_info %}
                <h4 style="margin-bottom: 15px;">ë³¸ì¸ ê¸°ë³¸ ê¸‰ì—¬ ì •ë³´</h4>
                <table class="employee-detail-table">
                    <tr><th>ì—°ë´‰/ê¸°ë³¸ê¸‰</th><td><strong>{{ "{:,}".format(salary_info['base_salary']) }}ì›</strong></td></tr>
                    <tr><th>ê³„ì•½ í˜•íƒœ</th><td>{{ salary_info['contract_type'] }}</td></tr>
                    <tr><th>ì§€ê¸‰ ì£¼ê¸°</th><td>{{ salary_info['payment_cycle'] }}</td></tr>
                    <tr><th>ê³ ì • ìˆ˜ë‹¹</th><td>{{ "{:,}".format(salary_info['allowance']) }}ì›</td></tr>
                    <tr><th>ì ìš© ì„¸ìœ¨</th><td>{{ "{:.1%}".format(salary_info['tax_rate']) }}</td></tr>
                </table>
            {% else %}
                <div class="alert alert-danger" style="grid-column: 1 / 3;">
                    ë“±ë¡ëœ ê¸°ë³¸ ê¸‰ì—¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì¸ì‚¬íŒ€ì— ë¬¸ì˜í•´ ì£¼ì„¸ìš”.
                </div>
            {% endif %}

            <h4 style="margin-top: 30px; margin-bottom: 15px;">ì›”ë³„ ê¸‰ì—¬ ì§€ê¸‰ ê¸°ë¡</h4>
            
            {% if payroll_records %}
            <table class="employee-table">
                <thead>
                    <tr>
                        <th style="width: 120px;">ì§€ê¸‰ ì—°ì›”</th>
                        <th style="text-align: right;">ì´ ì§€ê¸‰ì•¡</th>
                        <th style="text-align: right;">ì´ ê³µì œì•¡</th>
                        <th style="text-align: right;">ì‹¤ ìˆ˜ë ¹ì•¡</th>
                        <th style="width: 100px; text-align: center;">ëª…ì„¸ì„œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in payroll_records %}
                    <tr>
                        <td>{{ record['pay_date'] }}</td>
                        <td style="text-align: right;">{{ "{:,}".format(record['gross_pay']) }}ì›</td>
                        <td style="text-align: right; color: #e74c3c;">- {{ "{:,}".format(record['deductions']) }}ì›</td>
                        <td style="text-align: right; font-weight: bold;">{{ "{:,}".format(record['net_pay']) }}ì›</td>
                        <td style="text-align: center;">
                            {# âœ¨ [ìˆ˜ì •] pay_dateë¥¼ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬ #}
                            <a href="{{ url_for('view_payroll', employee_id=g.user.id, pay_date=record['pay_date']) }}" class="detail-btn">ìƒì„¸ ì¡°íšŒ</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
                <p style="color: #7f8c8d;">ì§€ê¸‰ëœ ê¸‰ì—¬ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}

        {% endif %}
    </div>
</div>

{% endblock %}