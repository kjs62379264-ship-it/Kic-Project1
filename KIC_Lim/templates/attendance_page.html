{% extends "base.html" %}

{% block title %}ê·¼íƒœ ê´€ë¦¬ ì‹œìŠ¤í…œ{% endblock %}
{% block body_class %}attendance-page-3-grid{% endblock %} 

{% block page_content %}

<div class="card attendance-box-top" style="grid-column: 1 / 3; max-height: 700px;"> 
    <div class="card-header employee-list-header">
        <div>ê·¼ë¬´ ë¦¬ìŠ¤íŠ¸ ({{ employees | length }}ëª…)</div>
        <div class="header-actions">
            {# âœ¨ ê·¼íƒœ ìš”ì²­ ë²„íŠ¼ ì¶”ê°€ #}
            <a href="{{ url_for('add_leave_request') }}" class="main-action-btn header-btn">âœˆï¸ ê·¼íƒœ ìš”ì²­</a>
            <input type="date" value="{{ today_date }}" style="padding: 5px; border-radius: 5px; border: 1px solid #ccc;">
            <a href="{{ url_for('attendance') }}" class="sub-action-btn header-btn">âŸ³ ì˜¤ëŠ˜</a>
        </div>
    </div>
    
    <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
        <form method="GET" action="{{ url_for('attendance') }}">
            <div class="search-filters" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                
                <span>ì‚¬ë²ˆ: <input type="text" name="id" placeholder="ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰" style="width: 120px;" value="{{ request.args.get('id', '') }}"></span>
                <span>ì´ë¦„: <input type="text" name="name" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰" style="width: 120px;" value="{{ request.args.get('name', '') }}"></span>

                <span>ë¶€ì„œ: 
                    <select name="department">
                        <option value="" {% if request.args.get('department', '') == '' %}selected{% endif %}>-- ì „ì²´ --</option>
                        {% for dept in departments %}
                        <option value="{{ dept['name'] }}" {% if request.args.get('department') == dept['name'] %}selected{% endif %}>{{ dept['name'] }}</option>
                        {% endfor %}
                    </select>
                </span>

                <span>ì§ê¸‰: 
                    <select name="position">
                        <option value="" {% if request.args.get('position', '') == '' %}selected{% endif %}>-- ì „ì²´ --</option>
                        {% for pos in positions %}
                        <option value="{{ pos['name'] }}" {% if request.args.get('position') == pos['name'] %}selected{% endif %}>{{ pos['name'] }}</option>
                        {% endfor %}
                    </select>
                </span>

                <span>ìƒíƒœ: 
                    <select name="status">
                        <option value="" {% if request.args.get('status', '') == '' %}selected{% endif %}>-- ì „ì²´ --</option>
                        <option value="ì¬ì‹¤" {% if request.args.get('status') == 'ì¬ì‹¤' %}selected{% endif %}>ì¬ì‹¤</option>
                        <option value="íœ´ê°€" {% if request.args.get('status') == 'íœ´ê°€' %}selected{% endif %}>íœ´ê°€</option>
                        <option value="ë¶€ì¬" {% if request.args.get('status') == 'ë¶€ì¬' %}selected{% endif %}>ë¶€ì¬</option>
                        <option value="ì™¸ê·¼/ì¶œì¥" {% if request.args.get('status') == 'ì™¸ê·¼/ì¶œì¥' %}selected{% endif %}>ì™¸ê·¼/ì¶œì¥</option>
                    </select>
                </span>

                <div style="margin-left: auto; display: flex; gap: 10px;">
                    <button type="submit" class="sub-action-btn header-btn">ê²€ìƒ‰</button>
                    <a href="{{ url_for('attendance') }}" class="sub-action-btn header-btn" style="background-color: #7f8c8d; text-decoration: none;">ì´ˆê¸°í™”</a>
                </div>
            </div>
        </form>
    </div>
    
    <div class="card-body" style="padding-top: 10px; overflow-y: auto;">
        <table class="employee-table">
            <thead>
                <tr>
                    <th style="width: 100px;">ìƒíƒœ</th>
                    <th>ì‚¬ë²ˆ</th> 
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th>ì§ê¸‰</th>
                    <th>ì¶œê·¼ ì‹œê°„</th>
                    <th>í‡´ê·¼ ì‹œê°„</th>
                    <th>ìƒì„¸</th> 
                </tr>
            </thead>
            <tbody>
            {% for emp in filtered_employees %}
            {% set status_icon = 'â—' if emp['status'] == 'ì¬ì‹¤' or emp['status'] == 'í‡´ê·¼'
                                 else 'âœˆï¸' if emp['status'] in ['ì—°ì°¨', 'ì˜¤ì „ ë°˜ì°¨', 'ì˜¤í›„ ë°˜ì°¨', 'ë³‘ê°€', 'ê¸°íƒ€']
                                 else 'ğŸš—' if emp['status'] in ['ì™¸ê·¼', 'ì¶œì¥'] 
                                 else 'âš ï¸' %}

            <tr style="{% if emp['status'] == 'ë¶€ì¬' %}background-color: #ffebee;{% endif %}">
                <td style="font-weight: bold; text-align: left;">
                    <span style="color: 
                        {% if emp['status'] == 'ì¬ì‹¤' or emp['status'] == 'í‡´ê·¼' %}#2ecc71
                        {% elif emp['status'] in ['ì—°ì°¨', 'ì˜¤ì „ ë°˜ì°¨', 'ì˜¤í›„ ë°˜ì°¨', 'ë³‘ê°€', 'ê¸°íƒ€'] %}#3498db
                        {% elif emp['status'] in ['ì™¸ê·¼', 'ì¶œì¥'] %}#f39c12
                        {% else %}#e74c3c
                        {% endif %};">
                        {{ status_icon }} {{ emp['status'] }}
                    </span>
                </td>
                
                <td>{{ emp['id'] }}</td> 
                
                <td>{{ emp['name'] }}</td>
                <td>{{ emp['department'] }}</td>
                <td>{{ emp['position'] }}</td>
                <td>{{ emp['check_in'] if emp['check_in'] else '-' }}</td>
                <td>{{ emp['check_out'] if emp['check_out'] else '-' }}</td>
                
                <td>
                    <a href="{{ url_for('attendance_detail', employee_id=emp['id']) }}" class="detail-btn">ì¡°íšŒ</a>
                </td> 
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card attendance-box-bottom-left">
    <div class="card-header">ê·¼ë¬´ í˜„í™© (ì´ {{ total_employees_count }}ëª…)</div>
    <div class="card-body attendance-summary-circles">
        <div class="status-circle-item">
            <div class="circle green-bg">
                <span class="count">{{ status_counts['ì¬ì‹¤'] }}</span>ëª…
            </div>
            <div class="label">ì¬ì‹¤/í‡´ê·¼</div>
        </div>
        <div class="status-circle-item">
            <div class="circle blue-bg">
                <span class="count">{{ status_counts['íœ´ê°€'] }}</span>ëª…
            </div>
            <div class="label">íœ´ê°€/ë³‘ê°€</div>
        </div>
        <div class="status-circle-item">
            <div class="circle orange-bg">
                <span class="count">{{ status_counts['ì™¸ê·¼/ì¶œì¥'] }}</span>ëª…
            </div>
            <div class="label">ì™¸ê·¼/ì¶œì¥</div>
        </div>
        <div class="status-circle-item">
            <div class="circle red-bg">
                <span class="count">{{ status_counts['ë¶€ì¬'] }}</span>ëª…
            </div>
            <div class="label">ë¯¸ì¶œê·¼ (ë¶€ì¬)</div>
        </div>
    </div>
</div>

<div class="card attendance-box-bottom-right">
    <div class="card-header">
        <span>ê·¼íƒœ ìš”ì²­ í˜„í™© ({{ 'ë¯¸ìŠ¹ì¸' if g.user.role == 'admin' else 'ë‚˜ì˜ ì „ì²´ ìš”ì²­' }})</span>
        {# âœ¨ ì¼ë°˜ ì§ì› ëª¨ë“œì—ì„œë§Œ ìš”ì²­ ë²„íŠ¼ ì¶”ê°€ #}
        {% if g.user.role != 'admin' %}
        <a href="{{ url_for('add_leave_request') }}" class="sub-action-btn header-btn">â• ìš”ì²­í•˜ê¸°</a>
        {% endif %}
    </div>
    <div class="card-body" style="padding-bottom: 5px; display: flex; flex-direction: column;">
        
        <div style="overflow-y: auto;">
            <table class="employee-table" style="font-size: 0.9em; width: 100%;">
                <thead>
                <tr>
                    <th style="width: 20%;">ì´ë¦„(ë¶€ì„œ)</th> 
                    <th style="width: 15%;">ìš”ì²­ ìœ í˜•</th> 
                    <th style="width: 25%;">ê¸°ê°„</th> 
                    <th style="width: 15%;">ìš”ì²­ì¼</th>
                    <th style="width: 25%; text-align: center;">ì²˜ë¦¬ í˜„í™©</th>
                </tr>
                </thead>
                <tbody>
                {% for req in pending_requests %}
                    <tr>
                        <td>{{ req['name'] }} ({{ req['department'][:2] }})</td> 
                        <td>{{ req['request_type'] }}</td>
                        {# ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì´ ê°™ìœ¼ë©´ í•˜ë£¨ë§Œ í‘œì‹œ #}
                        <td>
                            {{ req['start_date'] | replace('-', '.') }}
                            {% if req['start_date'] != req['end_date'] %}
                                ~ {{ req['end_date'] | replace('-', '.') }}
                            {% endif %}
                        </td>
                        <td>{{ req['requested_at'].split(' ')[0] | replace('-', '.') }}</td>
                        
                        <td style="text-align: center;">
                            {% if req['status'] == 'ìŠ¹ì¸' %}
                                <span class="status-indicator approved">ìŠ¹ì¸</span>
                            {% elif req['status'] == 'ë°˜ë ¤' %}
                                <span class="status-indicator rejected">ë°˜ë ¤</span>
                            {% else %}
                                <span class="status-indicator pending">ë¯¸ìŠ¹ì¸</span>
                                
                                {# âœ¨ [ê´€ë¦¬ì ì „ìš©] ìŠ¹ì¸/ë°˜ë ¤ í¼ #}
                                {% if g.user.role == 'admin' %}
                                <form method="POST" action="{{ url_for('process_leave_request', request_id=req['id']) }}" style="display: inline-flex; gap: 5px; margin-left: 5px;">
                                    <button type="submit" name="action" value="ìŠ¹ì¸" class="detail-btn" style="background-color: #2ecc71; color: white; padding: 3px 6px;">O</button>
                                    <button type="submit" name="action" value="ë°˜ë ¤" class="detail-btn" style="background-color: #e74c3c; color: white; padding: 3px 6px;">X</button>
                                </form>
                                {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                
                {# ìš”ì²­ì´ ìˆì§€ë§Œ í˜ì´ì§€ë‹¹ ê°œìˆ˜ë³´ë‹¤ ì ì„ ë•Œ ë¹ˆ ì¹¸ ì±„ìš°ê¸° (UX ê°œì„ ) #}
                {% if total_requests == 0 %}
                    <tr>
                        <td colspan="5" style="text-align: center; color: #7f8c8d; height: 105px;">í˜„ì¬ ê·¼íƒœ ìš”ì²­ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                    </tr>
                {% elif pending_requests|length < 3 %}
                    {% set num_rows_to_add = 3 - pending_requests|length %}
                    {% for i in range(num_rows_to_add) %}
                        <tr><td colspan="5" style="height: 35px; background-color: #fcfcfc; border: none;"></td></tr>
                    {% endfor %}
                {% endif %}
                
                </tbody>
            </table>
        </div>

        {# í˜ì´ì§€ë„¤ì´ì…˜ #}
        {% if total_pages > 1 %}
        <div style="margin-top: 10px; text-align: center; padding: 5px 0; flex-shrink: 0;"> 
            {% for p in range(1, total_pages + 1) %}
                {% set page_url = url_for('attendance', pending_page=p, **request.args) %}
                <a href="{{ page_url }}" 
                   style="display: inline-block; padding: 5px 10px; margin: 0 2px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; font-size: 0.9em;
                          {% if p == current_pending_page %}background-color: #3498db; color: white; border-color: #3498db;{% else %}background-color: white; color: #333;{% endif %}">
                    {{ p }}
                </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}