{% extends "base.html" %}

{% block page_title %}ì¸ì‚¬ ê´€ë¦¬ - ì§ì› ì •ë³´{% endblock %}

{% block page_content %}

<div class="card employee-list-container" style="grid-column: 1 / 3;">
    
    <div class="card-header employee-list-header">
        <div>ì§ì› ëª…ë¶€ (ì´ {{ employee_count }}ëª…)</div>
        <div class="header-actions">
            {% if g.user.role == 'admin' %}
            <a href="{{ url_for('print_employees', **request.args) }}" target="_blank" class="sub-action-btn header-btn">ğŸ–¨ï¸ ëª…ë¶€ ì¸ì‡„</a>
            <a href="{{ url_for('add_employee') }}" class="main-action-btn header-btn">â• ì‹ ê·œ ì§ì› ë“±ë¡</a>
            {% endif %}
        </div>
    </div>

    <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
        <form method="GET" action="{{ url_for('hr_management') }}">
            <div class="search-filters" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center; flex-grow: 1;">
                    <span>ì‚¬ë²ˆ: <input type="text" name="id" placeholder="ì‚¬ë²ˆìœ¼ë¡œ ê²€ìƒ‰" style="width: 120px;" value="{{ request.args.get('id', '') }}"></span>
                    <span>ì´ë¦„: <input type="text" name="name" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰" style="width: 120px;" value="{{ request.args.get('name', '') }}"></span>
                    <span>ë¶€ì„œ: 
                        <select name="department">
                            <option value="" {% if request.args.get('department', '') == '' %}selected{% endif %}>-- ì „ì²´ --</option>
                            {% for dept in departments %}
                            <option value="{{ dept['name'] }}" {% if request.args.get('department') == dept['name'] %}selected{% endif %}>
                                {{ dept['name'] }}
                            </option>
                            {% endfor %}
                        </select>
                    </span>
                    <span>ì§ê¸‰: 
                        <select name="position">
                            <option value="" {% if request.args.get('position', '') == '' %}selected{% endif %}>-- ì „ì²´ --</option>
                            {% for pos in positions %}
                            <option value="{{ pos['name'] }}" {% if request.args.get('position') == pos['name'] %}selected{% endif %}>
                                {{ pos['name'] }}
                            </option>
                            {% endfor %}
                        </select>
                    </span>
                    <span>ì„±ë³„: 
                        <select name="gender">
                            <option value="" {% if request.args.get('gender', '') == '' %}selected{% endif %}>-- ì „ì²´ --</option>
                            <option value="ë‚¨ì„±" {% if request.args.get('gender') == 'ë‚¨ì„±' %}selected{% endif %}>ë‚¨ì„±</option>
                            <option value="ì—¬ì„±" {% if request.args.get('gender') == 'ì—¬ì„±' %}selected{% endif %}>ì—¬ì„±</option>
                        </select>
                    </span>
                    <span>ìƒíƒœ: 
                        <select name="status">
                            <option value="ì¬ì§" {% if request.args.get('status', 'ì¬ì§') == 'ì¬ì§' %}selected{% endif %}>ì¬ì§</option>
                            <option value="í‡´ì‚¬" {% if request.args.get('status') == 'í‡´ì‚¬' %}selected{% endif %}>í‡´ì‚¬</option>
                            <option value="ì „ì²´" {% if request.args.get('status') == 'ì „ì²´' %}selected{% endif %}>ì „ì²´</option>
                        </select>
                    </span>
                </div>
                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button type="submit" class="sub-action-btn header-btn">ê²€ìƒ‰</button>
                    <a href="{{ url_for('hr_management') }}" class="sub-action-btn header-btn" style="background-color: #7f8c8d; text-decoration: none;">ì´ˆê¸°í™”</a>
                </div>
            </div>
        </form>
    </div>
    
    <div class="card-body" style="padding: 0 20px 10px 20px; overflow-y: auto; max-height: 325px;">
        
        <div style="position: sticky; top: 0; height: 15px; background-color: #ffffff; z-index: 10; width: 100%;"></div>

        <table class="employee-table" style="margin-top: 0;">
            <thead style="position: sticky; top: 15px; background-color: #f9f9f9; z-index: 5; box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1);">
                <tr>
                    <th>ì‚¬ë²ˆ</th>
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th>ì§ê¸‰</th>
                    <th>ìƒì„¸</th> 
                </tr>
            </thead>
            <tbody>
            {% for employee in employees %}
            <tr class="{{ 'resigned' if employee['status'] == 'í‡´ì‚¬' else '' }}">
                <td>{{ employee['id'] }}</td>
                <td>{{ employee['name'] }}</td>
                <td>{{ employee['department'] }}</td>
                <td>{{ employee['position'] }}</td>
                <td>
                    <a href="{{ url_for('employee_detail', employee_id=employee['id']) }}" class="detail-btn">ì¡°íšŒ</a>
                </td> 
            </tr>
            {% else %}
            <tr>
                <td colspan="5" style="text-align: center;">ë“±ë¡ëœ ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="card" style="grid-column: 1 / 2;">
    <div class="card-header employee-list-header">
        <span>ìµœì‹  ê³µì§€</span>
        {% if g.user.role == 'admin' %}
        <a href="{{ url_for('add_notice_page') }}" class="sub-action-btn header-btn">â• ìƒˆ ê¸€ ì‘ì„±</a>
        {% endif %}
    </div>
    <div class="card-body notice-list">
        {% for notice in notices %}
        <div class="notice-item">
            <div class="notice-header">
                <a href="{{ url_for('view_notice', notice_id=notice['id']) }}" class="notice-title-link">
                    <strong>{{ notice['title'] }}</strong>
                </a>
                {% if g.user.role == 'admin' %}
                <form action="{{ url_for('delete_notice', notice_id=notice['id']) }}" method="POST" onsubmit="return confirm('ì´ ê³µì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" style="display: inline;">
                    <button type="submit" class="delete-notice-btn">X</button>
                </form>
                {% endif %}
            </div>
            <p class="notice-content-preview">{{ (notice['content']|striptags|truncate(80))|replace('\n', ' ') }}</p>
        </div>
        {% else %}
        <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endfor %}
    </div>
</div>

<div class="card" style="grid-column: 2 / 3; max-height: 400px;">
    <div class="card-header">ë¶€ì„œë³„ ì¸ì› í˜„í™© (ì¬ì§ì ê¸°ì¤€)</div>
    <div class="card-body" style="overflow-y: auto;">
        <canvas id="departmentChart"></canvas>
    </div>
</div>

<script>
    const deptLabels = {{ dept_labels|tojson }};
    const deptCounts = {{ dept_counts|tojson }};
    const ctx = document.getElementById('departmentChart');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: deptLabels,
            datasets: [{
                label: 'ë¶€ì„œë³„ ì¸ì›',
                data: deptCounts,
                borderWidth: 1,
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)'
            }]
        },
        options: {
            scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
            plugins: { legend: { display: false } }
        }
    });

</script>

{% endblock %}