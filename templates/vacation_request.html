{% extends "base.html" %}

{% block title %}연차/휴가 신청{% endblock %}
{% block page_body_class %}vacation-request-page{% endblock %}

{% block page_content %}

<div class="two-column-form" style="grid-column: 1 / 3; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">

    <div class="card" style="min-height: 700px;">
        <div class="card-header">휴가 신청 정보 입력</div>
        <div class="card-body">
            
            <form id="vacation-form" method="POST" action="{{ url_for('vacation_request') }}">
                
                <div class="form-group"><label>성명:</label> <span>{{ g.user['name'] }}</span></div>
                <div class="form-group"><label>부서:</label> <span>{{ g.user['department'] }}</span></div>
                <div class="form-group"><label>직급:</label> <span>{{ g.user['position'] }}</span></div>
                <hr>

                <div class="form-group">
                    <label for="leave_type">신청 유형</label>
                    <select id="leave_type" name="leave_type" required onchange="updatePreview()">
                        <option value="">-- 유형 선택 --</option>
                        <option value="연차">연차</option>
                        <option value="오전 반차">오전 반차</option>
                        <option value="오후 반차">오후 반차</option>
                        <option value="병가">병가</option>
                        <option value="경조사">경조사 휴가</option>
                        <option value="기타">기타</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="start_date">휴가 시작일</label>
                    <input type="date" id="start_date" name="start_date" required onchange="updatePreview()">
                </div>

                <div class="form-group">
                    <label for="end_date">휴가 종료일</label>
                    <input type="date" id="end_date" name="end_date" required onchange="updatePreview()">
                </div>
                
                <div class="form-group">
                    <label for="reason">신청 사유</label>
                    <textarea id="reason" name="reason" rows="5" oninput="updatePreview()"></textarea>
                </div>
                
                <div class="form-actions" style="margin-top: 30px;">
                    <button type="submit" class="btn main-action-btn">최종 신청 및 제출</button>
                    <a href="{{ url_for('my_attendance') }}" class="btn sub-action-btn">취소</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card" style="padding: 30px; min-height: 700px; background-color: white; border: 1px solid #ccc;">
        <h2 style="text-align: center; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px;">휴가 신청서 (미리보기)</h2>
        
        <div id="preview-content" style="line-height: 1.8; font-family: serif; max-width: 500px; margin: 0 auto; padding-top: 20px;">
            <p style="text-align: center; font-size: 1.2em; font-weight: bold; margin-bottom: 40px;">휴가 신청서</p>

            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em;">
                <tr><th style="border: 1px solid #333; padding: 5px; width: 30%; background-color: #f0f0f0;">소속</th><td id="preview-dept" style="border: 1px solid #333; padding: 5px;">{{ g.user['department'] }}</td></tr>
                <tr><th style="border: 1px solid #333; padding: 5px; background-color: #f0f0f0;">직급/성명</th><td id="preview-name" style="border: 1px solid #333; padding: 5px;">{{ g.user['position'] }} / {{ g.user['name'] }}</td></tr>
            </table>

            <p style="font-size: 0.95em; margin-bottom: 30px;">
                상기 본인은 휴가 규정에 따라 아래와 같이 휴가를 신청합니다.
            </p>

            <h3 style="font-size: 1em; text-align: center; margin: 30px 0;">— 아 래 —</h3>

            <div style="border: 1px solid #333; padding: 15px; margin-bottom: 30px;">
                <p style="font-weight: bold; margin-bottom: 10px;">1. 휴가 종류: <span id="preview-type" style="color: #007bff; font-weight: normal;">[선택 필요]</span></p>
                <p style="font-weight: bold; margin-bottom: 10px;">2. 휴가 기간: <span id="preview-duration" style="color: #007bff; font-weight: normal;">[날짜 입력 필요]</span></p>
                <p style="font-weight: bold;">3. 신청 사유: <span id="preview-reason" style="color: #555; font-weight: normal; word-break: break-all;">-</span></p>
            </div>

            <p style="text-align: right; margin-top: 50px; font-size: 0.9em;">
                <span id="preview-date">{{ "now"|datetimeformat('%Y년 %m월 %d일') }}</span> 
                <br><br>
                신청인: <span style="font-weight: bold; text-decoration: none;">{{ g.user['name'] }}</span> (서명 또는 인) 
                </p>
            
            <p style="text-align: center; margin-top: 50px; font-weight: bold;">
                주식회사 I-TEK 대표이사 김명지
            </p>
        </div>
    </div>
</div>
{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 미리보기 업데이트 함수
        window.updatePreview = function() {
            const form = document.getElementById('vacation-form');
            
            // 1. 신청 유형 업데이트
            const leaveType = form.elements['leave_type'].value;
            document.getElementById('preview-type').textContent = leaveType || '[선택 필요]';

            // 2. 휴가 기간 업데이트
            const startDate = form.elements['start_date'].value;
            const endDate = form.elements['end_date'].value;
            let durationText = '[날짜 입력 필요]';

            if (startDate && endDate) {
                // 날짜 포맷팅 (YYYY-MM-DD -> YYYY. MM. DD. 로 간단히 표시)
                const format = (dateStr) => {
                    if (!dateStr) return '';
                    const parts = dateStr.split('-');
                    return `${parts[0]}. ${parts[1]}. ${parts[2]}.`;
                };
                
                // ✅ [핵심 수정] 휴가 종류(leaveType)를 기간 표시에서 완전히 제거
                durationText = `${format(startDate)} ~ ${format(endDate)}`; 
            }
            document.getElementById('preview-duration').textContent = durationText;

            // 3. 신청 사유 업데이트
            const reason = form.elements['reason'].value.trim();
            document.getElementById('preview-reason').textContent = reason || '-';
        };

        // 페이지 로드 시 초기값 설정 및 이벤트 리스너 연결
        const formElements = document.querySelectorAll('#vacation-form input, #vacation-form select, #vacation-form textarea');
        formElements.forEach(el => {
            el.addEventListener('input', updatePreview);
            el.addEventListener('change', updatePreview);
        });

        // 초기 미리보기 로드
        updatePreview();
    });
</script>
{% endblock %}
{% endblock %}