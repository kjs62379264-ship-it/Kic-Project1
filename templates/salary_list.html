{% extends "base.html" %}

{% block page_content %}
<div class="card" style="grid-column: 1 / -1;">
    <div class="card-header" style="flex-direction: column; align-items: stretch; gap: 15px;">
        
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="font-size: 1.2em; font-weight: bold;">ğŸ’° {{ year }}ë…„ {{ month }}ì›” ê¸‰ì—¬ ëŒ€ì¥</span>
                
                <form method="GET" action="{{ url_for('salary_payroll') }}" style="display: flex; gap: 5px; align-items: center;">
                    <select name="year" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        {% for y in range(2024, 2027) %}<option value="{{ y }}" {% if year == y %}selected{% endif %}>{{ y }}ë…„</option>{% endfor %}
                    </select>
                    <select name="month" style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                        {% for m in range(1, 13) %}<option value="{{ m }}" {% if month == m %}selected{% endif %}>{{ m }}ì›”</option>{% endfor %}
                    </select>
                    <button type="submit" class="sub-action-btn header-btn">ì´ë™</button>
                </form>
            </div>

            <div>
                {% if is_calculated %}
                <a href="{{ url_for('download_salary_excel', year=year, month=month) }}" class="btn sub-action-btn" style="background-color: #27ae60; color: white;">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</a>
                <form action="{{ url_for('calculate_all_salary') }}" method="POST" style="display:inline;" onsubmit="return confirm('ì¬ê³„ì‚° í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                    <button type="submit" class="btn sub-action-btn">ğŸ”„ ì¬ê³„ì‚°</button>
                </form>
                {% else %}
                <form action="{{ url_for('calculate_all_salary') }}" method="POST" style="display:inline;">
                    <button type="submit" class="btn main-action-btn">âš¡ ì¼ê´„ ê³„ì‚° ì‹¤í–‰</button>
                </form>
                {% endif %}
            </div>
        </div>

        <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; border: 1px solid #eee;">
            <form method="GET" action="{{ url_for('salary_payroll') }}" style="display: flex; gap: 15px; align-items: center;">
                <input type="hidden" name="year" value="{{ year }}">
                <input type="hidden" name="month" value="{{ month }}">
                
                <span>ğŸ” ê²€ìƒ‰: </span>
                <select name="search_dept" style="padding: 6px;">
                    <option value="">-- ë¶€ì„œ ì „ì²´ --</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}" {% if search_dept == dept %}selected{% endif %}>{{ dept }}</option>
                    {% endfor %}
                </select>
                <input type="text" name="search_name" placeholder="ì´ë¦„ ê²€ìƒ‰" value="{{ search_name }}" style="padding: 6px;">
                <button type="submit" class="btn sub-action-btn" style="padding: 6px 15px;">ê²€ìƒ‰ ì ìš©</button>
                <a href="{{ url_for('salary_payroll', year=year, month=month) }}" class="btn sub-action-btn" style="background-color: #95a5a6;">ì´ˆê¸°í™”</a>
            </form>
        </div>
    </div>

    <div class="card-body">
        <table class="employee-table">
            <thead>
                <tr>
                    <th>ì‚¬ë²ˆ</th>
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th style="background-color: #fffde7;">ì§ê¸‰</th>
                    
                    <th>ì§€ê¸‰ ì´ì•¡ <small>(ê¸°ë³¸+ìˆ˜ë‹¹+ì•¼ê·¼)</small></th>
                    <th style="color: #c0392b;">ê³µì œ ì´ì•¡</th>
                    <th style="background-color: #e8f5e9; color: #2ecc71;">ì‹¤ ìˆ˜ë ¹ì•¡</th>
                    <th>ìƒì„¸ë³´ê¸°</th>
                </tr>
            </thead>
            <tbody>
            {% for pay in payrolls %}
                <tr>
                    <td>{{ pay.employee_id }}</td>
                    <td>{{ pay.name }}</td>
                    <td>{{ pay.department }}</td>
                    <td style="font-weight: bold;">{{ pay.position }}</td>
                    
                    <td style="text-align: right;">
                        {{ (pay.total_base + pay.total_allowance + pay.overtime_pay)|comma }}
                    </td>
                    
                    <td style="text-align: right; color: #e74c3c;">
                        {{ pay.total_deduction|comma }}
                    </td>
                    
                    <td style="text-align: right; color: #27ae60; font-weight: bold; font-size: 1.05em;">
                        {{ pay.net_salary|comma }}
                    </td>
                    
                    <td style="text-align: center;">
                        <button type="button" class="detail-btn" 
                            onclick='openSalaryModal({{ pay|tojson }})'>
                            ğŸ“„ ìƒì„¸
                        </button>
                    </td>
                </tr>
            {% else %}
                <tr><td colspan="8" style="text-align:center; padding: 30px;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
            {% endfor %}
            </tbody>
            
            {% if is_calculated %}
            <tfoot style="background-color: #f1f2f6; font-weight: bold; border-top: 2px solid #333;">
                <tr>
                    <td colspan="4" style="text-align: center;">í•© ê³„ (Total)</td>
                    <td style="text-align: right;">{{ grand_total.total_pay|comma }}</td>
                    <td style="text-align: right; color: #c0392b;">{{ grand_total.deduction|comma }}</td>
                    <td style="text-align: right; color: #27ae60;">{{ grand_total.net|comma }}</td>
                    <td></td>
                </tr>
            </tfoot>
            {% endif %}
        </table>
    </div>
</div>

<div id="salaryDetailModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close" onclick="closeSalaryModal()">&times;</span>
        <h3 style="border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <span id="modalName"></span>ë‹˜ì˜ ê¸‰ì—¬ ìƒì„¸
        </h3>
        
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h4 style="color: #2980b9;">â• ì§€ê¸‰ ë‚´ì—­</h4>
                <table class="employee-table" style="font-size: 0.9em;">
                    <tr><th>ê¸°ë³¸ê¸‰</th><td id="modalBase" style="text-align: right;"></td></tr>
                    <tr><th>ì¼ë°˜ìˆ˜ë‹¹</th><td id="modalAllow" style="text-align: right;"></td></tr>
                    <tr style="background-color: #fff3cd;"><th>ì•¼ê·¼ìˆ˜ë‹¹</th><td id="modalOver" style="text-align: right; font-weight: bold;"></td></tr>
                    <tr style="border-top: 2px solid #ddd;"><th>ì§€ê¸‰ê³„</th><td id="modalTotalPay" style="text-align: right;"></td></tr>
                </table>
            </div>
            
            <div style="flex: 1;">
                <h4 style="color: #c0392b;">â– ê³µì œ ë‚´ì—­</h4>
                <table class="employee-table" style="font-size: 0.9em;">
                    <tr><th>êµ­ë¯¼ì—°ê¸ˆ</th><td id="modalPension" style="text-align: right;"></td></tr>
                    <tr><th>ê±´ê°•ë³´í—˜</th><td id="modalHealth" style="text-align: right;"></td></tr>
                    <tr><th>ì¥ê¸°ìš”ì–‘</th><td id="modalCare" style="text-align: right;"></td></tr>
                    <tr><th>ê³ ìš©ë³´í—˜</th><td id="modalEmpIns" style="text-align: right;"></td></tr>
                    <tr><th>ì†Œë“ì„¸</th><td id="modalTax" style="text-align: right;"></td></tr>
                    <tr style="border-top: 2px solid #ddd;"><th>ê³µì œê³„</th><td id="modalTotalDed" style="text-align: right;"></td></tr>
                </table>
            </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; padding: 15px; background-color: #e8f5e9; border-radius: 8px;">
            <strong>ì‹¤ ìˆ˜ë ¹ì•¡: </strong> <span id="modalNet" style="font-size: 1.5em; color: #27ae60; font-weight: bold;"></span> ì›
        </div>
    </div>
</div>

<script>
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function openSalaryModal(data) {
        // ê¸°ë³¸ ì •ë³´
        document.getElementById('modalName').innerText = data.name + " " + data.position;
        
        // ì§€ê¸‰
        document.getElementById('modalBase').innerText = formatNumber(data.total_base);
        document.getElementById('modalAllow').innerText = formatNumber(data.total_allowance);
        document.getElementById('modalOver').innerText = formatNumber(data.overtime_pay);
        document.getElementById('modalTotalPay').innerText = formatNumber(data.total_base + data.total_allowance + data.overtime_pay);
        
        // ê³µì œ
        document.getElementById('modalPension').innerText = formatNumber(data.national_pension);
        document.getElementById('modalHealth').innerText = formatNumber(data.health_insurance);
        document.getElementById('modalCare').innerText = formatNumber(data.care_insurance);
        document.getElementById('modalEmpIns').innerText = formatNumber(data.employment_insurance);
        document.getElementById('modalTax').innerText = formatNumber(data.income_tax + data.local_tax); // ì†Œë“ì„¸+ì§€ë°©ì„¸ í•©ì‚° í‘œì‹œ
        document.getElementById('modalTotalDed').innerText = formatNumber(data.total_deduction);
        
        // ì‹¤ ìˆ˜ë ¹
        document.getElementById('modalNet').innerText = formatNumber(data.net_salary);
        
        document.getElementById('salaryDetailModal').style.display = 'block';
    }

    function closeSalaryModal() {
        document.getElementById('salaryDetailModal').style.display = 'none';
    }

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        const modal = document.getElementById('salaryDetailModal');
        if (event.target == modal) {
            closeSalaryModal();
        }
    }
</script>
{% endblock %}