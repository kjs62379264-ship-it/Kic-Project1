{% extends "base.html" %}

{% block title %}ê¸‰ì—¬ ìˆ˜ë‹¹/ê³µì œ ê´€ë¦¬{% endblock %}

{% block page_content %}

<div class="card" style="grid-column: 1 / -1; margin-bottom: 20px;">
    <div class="card-header">
        <span>âš¡ ê·¸ë£¹ë³„ ìˆ˜ë‹¹/ê³µì œ ì¼ê´„ ë“±ë¡</span>
        <small style="color: #666; font-weight: normal; margin-left: 10px;">(ëª©ë¡ì—ì„œ ëŒ€ìƒì„ ì„ íƒí•˜ì—¬ ì¼ê´„ ì ìš©í•©ë‹ˆë‹¤)</small>
    </div>
    <div class="card-body" style="background-color: #f9fbfd;">
        <form action="{{ url_for('add_group_item') }}" method="POST" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
            
            <div style="display: flex; align-items: center; gap: 5px;">
                <label style="font-weight: bold;">ëŒ€ìƒ:</label>
                <select name="target_type" id="target_type" onchange="toggleTargetInput()" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                    <option value="all">ğŸ¢ ì „ ì§ì›</option>
                    <option value="department">ğŸ“‚ ë¶€ì„œë³„</option>
                    <option value="position">ğŸ–ï¸ ì§ê¸‰ë³„</option>
                    <option value="individual">ğŸ‘¤ ê°œì¸ë³„</option>
                </select>
            </div>
            
            <div id="div_dept" style="display: none;">
                <select id="input_dept" name="target_value" disabled style="padding: 8px; min-width: 150px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                    <option value="">-- ë¶€ì„œ ì„ íƒ --</option>
                    {% for dept in departments %}
                    <option value="{{ dept }}">{{ dept }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="div_pos" style="display: none;">
                <select id="input_pos" name="target_value" disabled style="padding: 8px; min-width: 150px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                    <option value="">-- ì§ê¸‰ ì„ íƒ --</option>
                    {% for pos in positions %}
                    <option value="{{ pos }}">{{ pos }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="div_indiv" style="display: none;">
                <select id="input_indiv" name="target_value" disabled style="padding: 8px; min-width: 200px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                    <option value="">-- ì§ì› ì„ íƒ --</option>
                    {% for emp in employees %}
                    <option value="{{ emp.id }}">{{ emp.name }} ({{ emp.department }} {{ emp.position }})</option>
                    {% endfor %}
                </select>
            </div>

            <div style="display: flex; align-items: center; gap: 5px;">
                <label style="font-weight: bold;">ìœ í˜•:</label>
                <select name="item_type" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer;">
                    <option value="allowance">â• ìˆ˜ë‹¹ (ì§€ê¸‰)</option>
                    <option value="deduction">â– ê³µì œ (ì°¨ê°)</option>
                </select>
            </div>

            <input type="text" name="item_name" placeholder="í•­ëª©ëª… (ì˜ˆ: ëª…ì ˆë³´ë„ˆìŠ¤)" required style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
            <input type="text" name="amount" placeholder="ê¸ˆì•¡ (ì›)" required style="padding: 8px; text-align: right; border: 1px solid #ccc; border-radius: 4px; width: 100px;">

            <button type="submit" class="btn main-action-btn" style="padding: 8px 20px;">ì¼ê´„ ë“±ë¡</button>
        </form>
    </div>
</div>

<script>
    function toggleTargetInput() {
        const type = document.getElementById('target_type').value;
        
        // ëª¨ë“  ì…ë ¥ div ê°€ì ¸ì˜¤ê¸°
        const divDept = document.getElementById('div_dept');
        const divPos = document.getElementById('div_pos');
        const divIndiv = document.getElementById('div_indiv');
        
        // ëª¨ë“  ì‹¤ì œ ì…ë ¥ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const inputDept = document.getElementById('input_dept');
        const inputPos = document.getElementById('input_pos');
        const inputIndiv = document.getElementById('input_indiv');

        // 1. ì¼ë‹¨ ë‹¤ ìˆ¨ê¸°ê³  ë¹„í™œì„±í™” (ì „ì†¡ ë°©ì§€)
        divDept.style.display = 'none'; inputDept.disabled = true;
        divPos.style.display = 'none'; inputPos.disabled = true;
        divIndiv.style.display = 'none'; inputIndiv.disabled = true;

        // 2. ì„ íƒëœ ìœ í˜•ì— ë”°ë¼ í•´ë‹¹ ë¦¬ìŠ¤íŠ¸ë§Œ ë³´ì—¬ì£¼ê³  í™œì„±í™”
        if (type === 'department') {
            divDept.style.display = 'block';
            inputDept.disabled = false;
        } else if (type === 'position') {
            divPos.style.display = 'block';
            inputPos.disabled = false;
        } else if (type === 'individual') {
            divIndiv.style.display = 'block';
            inputIndiv.disabled = false;
        }
        // 'all'ì¸ ê²½ìš°ëŠ” ì¶”ê°€ ì„ íƒì°½ì´ í•„ìš” ì—†ìŒ
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
    document.addEventListener('DOMContentLoaded', toggleTargetInput);
</script>

<div class="card" style="grid-column: 1 / -1;">
    <div class="card-header">
        <span>ì§ì›ë³„ ê³ ì • ê³µì œ ë‚´ì—­ (ê¸°ì¡´ ë°ì´í„°)</span>
    </div>
    <div class="card-body">
        <table class="employee-table">
            <thead>
                <tr>
                    <th style="width: 15%;">ì§ì› ì •ë³´</th>
                    <th style="width: 50%;">í˜„ì¬ ê³µì œ í•­ëª© ë¦¬ìŠ¤íŠ¸</th>
                    <th style="width: 35%;">ê°œë³„ í•­ëª© ì¶”ê°€</th>
                </tr>
            </thead>
            <tbody>
            {% for emp in employees %}
            <tr>
                <td style="vertical-align: top; padding-top: 15px;">
                    <strong>{{ emp.name }}</strong><br>
                    <span style="font-size: 0.9em; color: #555;">{{ emp.department }} {{ emp.position }}</span><br>
                    <span style="font-size: 0.8em; color: #999;">({{ emp.id }})</span>
                </td>
                
                <td style="vertical-align: top;">
                    {% set items = deduction_map[emp.id] %}
                    {% if items %}
                        <ul style="list-style: none; padding: 0; margin: 0;">
                        {% for item in items %}
                            <li style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 5px 0;">
                                <span>{{ item.deduction_name }} : <strong style="color: #e74c3c;">-{{ item.amount|comma }}ì›</strong></span>
                                <form action="{{ url_for('delete_deduction', deduction_id=item.id) }}" method="POST" style="display: inline;">
                                    <button type="submit" class="delete-notice-btn" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">X</button>
                                </form>
                            </li>
                        {% endfor %}
                        </ul>
                    {% else %}
                        <span style="color: #ccc;">ë“±ë¡ëœ ì¶”ê°€ ê³µì œê°€ ì—†ìŠµë‹ˆë‹¤.</span>
                    {% endif %}
                </td>
                
                <td style="vertical-align: top; background-color: #f9f9f9;">
                    <form action="{{ url_for('add_deduction') }}" method="POST" style="display: flex; gap: 5px; align-items: center;">
                        <input type="hidden" name="employee_id" value="{{ emp.id }}">
                        <input type="text" name="deduction_name" placeholder="í•­ëª©ëª…" required style="width: 120px; font-size: 0.9em;">
                        <input type="text" name="amount" placeholder="ê¸ˆì•¡" required style="width: 80px; text-align: right; font-size: 0.9em;">
                        <button type="submit" class="btn sub-action-btn" style="padding: 5px 10px; font-size: 0.9em;">ì¶”ê°€</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}